---
type: urban_mapping
title: 约束与控制变量 在城市复杂动力建模中的作用
tags: ['urban', 'constraints', 'M0']
prereq: ['热力学势 Thermodynamic potentials']
source: ['project framing']
status: ready
---

## 一句话
把城市系统的“观测到的聚合量”写成约束，并用最大熵得到指数族分布；其对数配分函数 \(\ln Z\)（或规模可变时 \(\ln\mathcal{Z}\)）是对偶参数的生成函数：一阶导给约束量的期望，二阶导给协方差（涨落/敏感性）。

## 0) 先把符号钉死
- 微观态 \(x\)：个体/出行的完整配置（目的地、路径、是否迁移…）。
- 代价 \(E(x)\)：总广义成本/负效用（时间、金钱、不便、拥堵外部性…）。
- \(\beta\)：噪声尺度的倒数（成本敏感度）；\(\beta\) 越大代表越“理性/确定”。  
  约定提醒：本仓库默认 \(E\) 是“成本/负效用”（越小越偏好）；如使用效用 \(U\)，请显式写 \(U=-E\)（见：[[符号约定与映射（本仓库统一：Swendsen 体系）]]）。

---

## 1) \(Z\) / \(\mathcal{Z}\) 是什么？
它们都是**配分函数（partition function）**：把所有可能微观态的“权重”加总得到的归一化常数。

### 正则（\(T\) 固定、\(N\) 固定）
\[
p(x)=\frac{1}{Z(\beta)}e^{-\beta E(x)},\qquad
Z(\beta)=\sum_x e^{-\beta E(x)}.
\]

### 巨正则（\(T\) 固定、\(N\) 可变，用 \(\mu\) 控制规模）
\[
p(x,N)=\frac{1}{\mathcal{Z}(\beta,\mu)}e^{-\beta(E(x,N)-\mu N)},\qquad
\mathcal{Z}(\beta,\mu)=\sum_N\sum_{x\in N}e^{-\beta(E(x,N)-\mu N)}.
\]

> 说明：你之前看到的 “\(\ln Z / \ln\mathcal{Z}\)” 里的 “/” 是“或”，不是除法；本仓库统一写作“\(\ln Z\) 或 \(\ln\mathcal{Z}\)”。

---

## 2) 为什么是 \(\ln Z\)，而不是 \(Z\)？
1) **数值层面**：\(Z\) 是大量指数项求和，量级会非常大；取对数更稳定。  
2) **结构层面**：\(\ln Z\) 把“乘法结构”变成“加法结构”，便于推导与比较。  
3) **物理层面**：在统计物理里 \(F=-k_BT\ln Z\)，\(\ln Z\) 直接对应热力学势（见：[[从正则分布到自由能 F=-kT ln Z]]）。

---

## 3) “对 \(\ln Z\) 求导拿宏观量”是什么意思？
指数族/最大熵分布的通用形式是：
\[
p(x)=\frac{1}{Z(\lambda)}\exp\!\Big(-\sum_k \lambda_k f_k(x)\Big),
\qquad
Z(\lambda)=\sum_x \exp\!\Big(-\sum_k \lambda_k f_k(x)\Big).
\]
这里 \(f_k(x)\) 是你关心的宏观统计量（软约束），\(\lambda_k\) 是其对应的拉格朗日乘子（对偶参数）。

关键性质（生成关系）：
\[
\boxed{\frac{\partial \ln Z}{\partial \lambda_k}=-\mathbb{E}[f_k(x)]}
\]
\[
\boxed{\frac{\partial^2 \ln Z}{\partial \lambda_i\partial \lambda_j}=\mathrm{Cov}\!\big(f_i(x),f_j(x)\big)}.
\]

直观含义：
- **一阶导**：给出你要匹配的“平均宏观量”（预测均值）。
- **二阶导**：给出“涨落/协方差”，也就是误差条与对参数的敏感性（见：[[协方差与二阶导（通用）]]、[[涨落-响应 Fluctuation-response]]）。

---

## 4) 城市例子（最小可闭环）：只约束“平均出行成本”
把微观态 \(x\) 理解为“一次出行的路径/目的地选择”，令 \(f(x)=C(x)\) 为成本（时间/费用等），只引入一个乘子 \(\lambda=\beta\)：
\[
p(x)=\frac{1}{Z(\beta)}e^{-\beta C(x)},\qquad
Z(\beta)=\sum_x e^{-\beta C(x)}.
\]

这时：
\[
\frac{\partial \ln Z}{\partial \beta}=-\mathbb{E}[C(x)],
\qquad
\frac{\partial^2 \ln Z}{\partial \beta^2}=\mathrm{Var}(C).
\]

城市语言解读：
- 你调“成本敏感度”旋钮 \(\beta\)，\(\ln Z\) 的一阶导直接给出系统的**平均成本**；
- 二阶导给出成本波动，进而决定平均成本对 \(\beta\) 的**敏感性**（波动越大，局部响应越大）。

---

## 5) 为什么需要同时写 \(Z\) 和 \(\mathcal{Z}\)？
取决于你是否把“规模 \(N\)”当作固定量。
- **\(N\) 固定**（例如总出行次数/样本量已固定）：用 \(Z\)（正则/条件模型）。
- **\(N\) 会涨落**（例如事件数/人口规模随环境波动）：用 \(\mathcal{Z}\)（巨正则/开放系统），并引入 \(\mu\) 控制 \(\langle N\rangle\)。

常用生成关系（示意）：
\[
\langle N\rangle=\frac{1}{\beta}\frac{\partial}{\partial\mu}\ln\mathcal{Z},
\qquad
\mathrm{Var}(N)=\frac{1}{\beta^2}\frac{\partial^2}{\partial\mu^2}\ln\mathcal{Z}.
\]
更完整推导见：[[平均粒子数与涨落从 ln 𝒵 的导数得到]]。

---

## 6) 你在本仓库里怎么用这张卡？
把它当作“建模接口”：
1) 先在 Modules 里读问题叙事（M0/M1/M3/M4）。  
2) 再回到这张卡，把你的数据项写成 \(f_k(x)\) 与 \(\lambda_k\)。  
3) 最后用项目闭环：OD 的 MaxEnt/IPF 见 [p01_maxent_od](/projects/p01_maxent_od)；Logit/Boltzmann 见 [p02_logit_choice](/projects/p02_logit_choice)。

 
